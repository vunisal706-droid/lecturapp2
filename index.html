<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Lecturas - Primaria Andaluc√≠a</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header-icon {
            font-size: 80px;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .btn-outline {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .btn-chatgpt {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 1.3em;
            padding: 20px 40px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .btn-save-big {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            font-size: 1.4em;
            padding: 20px 40px;
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.4);
            border: 3px solid #fff;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .curso-btn {
            padding: 20px;
            border: 3px solid #e5e7eb;
            border-radius: 15px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .curso-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .curso-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .alert-info {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1e40af;
        }

        .alert-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            margin: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .pregunta-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .pregunta-texto {
            font-size: 1.5em;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 20px;
        }

        .opcion {
            background: white;
            padding: 15px 20px;
            border: 3px solid #e5e7eb;
            border-radius: 12px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
        }

        .opcion:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .opcion.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .resultado-correcto {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 3px solid #10b981;
        }

        .resultado-incorrecto {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 3px solid #ef4444;
        }

        .puntuacion {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin: 20px 0;
        }

        .puntuacion-numero {
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
        }

        .lectura-guardada {
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s;
        }

        .lectura-guardada:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .texto-lectura {
            background: #f9fafb;
            padding: 30px;
            border-radius: 15px;
            font-size: 1.3em;
            line-height: 1.8;
            color: #374151;
            border-left: 5px solid #667eea;
        }

        .actividad-box {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
            font-size: 1.2em;
            line-height: 1.6;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .badge-primary {
            background: #667eea;
            color: white;
        }

        .flex {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .flex-1 {
            flex: 1;
            min-width: 200px;
        }

        .hidden {
            display: none;
        }

        .prompt-box {
            background: #1f2937;
            color: #10b981;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .copy-indicator {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .footer {
            text-align: center;
            color: white;
            padding: 20px;
            margin-top: 40px;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .footer .heart {
            color: #ff6b6b;
            animation: heartbeat 1.5s infinite;
            display: inline-block;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1); }
        }

        .checkbox-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .checkbox-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: start;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 3px;
        }

        .checkbox-item label {
            flex: 1;
            cursor: pointer;
        }

        @media print {
            body {
                background: white;
                padding: 0;
                margin: 0;
            }

            .container, .card, .header, .footer, .btn, .modal {
                display: none !important;
            }

            #pagina-impresion {
                display: block !important;
            }
        }

        #pagina-impresion {
            display: none;
            background: white;
            color: black;
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            padding: 40px;
            max-width: 210mm;
            margin: 0 auto;
        }

        .print-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .print-header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .print-header .school {
            font-size: 1.2em;
            color: #6b7280;
            font-weight: 600;
        }

        .print-section {
            margin: 40px 0;
            page-break-inside: avoid;
        }

        .print-section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .print-content {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            margin: 15px 0;
        }

        .print-vocab-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #fde68a;
        }

        .print-pregunta {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            page-break-inside: avoid;
        }

        .print-pregunta-numero {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .print-pregunta-texto {
            font-size: 1.1em;
            margin: 15px 0;
            font-weight: 600;
        }

        .print-respuesta-espacio {
            min-height: 80px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            margin-top: 15px;
            background: #fafafa;
        }

        .print-texto-lectura {
            background: white;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #667eea;
            font-size: 1.1em;
            line-height: 1.8;
            text-align: justify;
        }

        .print-titulo-lectura {
            text-align: center;
            font-size: 2em;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-icon">üìö</div>
            <h1>Generador de Lecturas</h1>
            <p style="font-size: 1.1em;">Educaci√≥n Primaria</p>
            <p style="font-size: 1em; margin-top: 5px; opacity: 0.9;">CEIP Capitulaciones Santa Fe</p>
        </div>

        <!-- Pantalla Principal -->
        <div id="pantalla-config" class="card">
            <h2 class="card-title">üéØ Selecciona el tipo de generaci√≥n</h2>
            <div class="grid-2">
                <button class="btn btn-primary" onclick="seleccionarModo('libre')" style="padding: 30px; font-size: 1.2em;">
                    <span style="font-size: 2em;">üìù</span>
                    <div>
                        <div>Tipo Libre</div>
                        <small style="font-size: 0.8em; opacity: 0.9;">Genera una lectura seg√∫n el curso seleccionado</small>
                    </div>
                </button>
                <button class="btn btn-success" onclick="seleccionarModo('plan')" style="padding: 30px; font-size: 1.2em;">
                    <span style="font-size: 2em;">üìö</span>
                    <div>
                        <div>Plan de Lectura</div>
                        <small style="font-size: 0.8em; opacity: 0.9;">Seg√∫n el Plan de Lectura de Andaluc√≠a</small>
                    </div>
                </button>
            </div>
            <button class="btn btn-outline" onclick="mostrarGuardadas()" style="width: 100%; margin-top: 20px; padding: 20px; font-size: 1.2em;">
                üìñ Ver Lecturas Guardadas (<span id="contador-guardadas">0</span>)
            </button>
        </div>

        <!-- Configuraci√≥n de Lectura -->
        <div id="pantalla-configuracion" class="card hidden">
            <h2 class="card-title"><span id="modo-titulo"></span></h2>
            
            <div class="input-group">
                <label>Selecciona el curso:</label>
                <div class="grid-3" id="cursos-container"></div>
            </div>

            <div id="trimestre-container" class="input-group hidden">
                <label>Selecciona el trimestre:</label>
                <div class="grid-3">
                    <button class="curso-btn" onclick="seleccionarTrimestre('1')">1.¬∫ Trimestre</button>
                    <button class="curso-btn" onclick="seleccionarTrimestre('2')">2.¬∫ Trimestre</button>
                    <button class="curso-btn" onclick="seleccionarTrimestre('3')">3.¬∫ Trimestre</button>
                </div>
            </div>

            <div id="opciones-adicionales" class="hidden">
                <hr style="margin: 30px 0; border: none; border-top: 2px dashed #e5e7eb;">
                <h3 style="color: #667eea; margin-bottom: 20px;">‚ú® Opciones adicionales (opcional)</h3>
                
                <div class="input-group">
                    <label>üéØ Tema espec√≠fico:</label>
                    <input type="text" id="tema" placeholder="Ej: Los dinosaurios, El sistema solar, La amistad...">
                </div>

                <div class="input-group">
                    <label>‚ù§Ô∏è Valor a trabajar:</label>
                    <input type="text" id="valor" placeholder="Ej: Respeto, Solidaridad, Responsabilidad...">
                </div>

                <div class="input-group">
                    <label>üìö Vocabulario espec√≠fico a trabajar:</label>
                    <input type="text" id="vocabulario" placeholder="Ej: herb√≠voro, carn√≠voro, omn√≠voro">
                    <small style="color: #6b7280; display: block; margin-top: 5px;">Separa las palabras por comas</small>
                </div>
            </div>

            <div class="flex" style="margin-top: 30px;">
                <button class="btn btn-outline flex-1" onclick="volverInicio()">Cancelar</button>
                <button class="btn btn-primary flex-1" onclick="generarPrompt()">Generar Prompt</button>
            </div>
        </div>

        <!-- Pantalla de Prompt con instrucciones -->
        <div id="pantalla-prompt" class="card hidden">
            <h2 class="card-title">üöÄ Prompt generado para ChatGPT</h2>
            
            <div class="alert alert-warning">
                <strong>üìã Instrucciones:</strong>
                <ol style="margin: 10px 0 0 20px;">
                    <li>Haz clic en el bot√≥n verde "Ir a ChatGPT"</li>
                    <li>El prompt se copiar√° autom√°ticamente</li>
                    <li>En ChatGPT, pega el prompt (Ctrl+V) y env√≠alo</li>
                    <li>Copia toda la respuesta JSON que ChatGPT te devuelva</li>
                    <li>Vuelve aqu√≠ y p√©gala en el siguiente paso</li>
                </ol>
            </div>

            <div class="prompt-box" id="prompt-display"></div>

            <div class="flex" style="margin-top: 30px;">
                <button class="btn btn-outline flex-1" onclick="volverInicio()">‚Üê Volver al inicio</button>
                <button class="btn btn-chatgpt flex-1" onclick="irAChatGPT()">
                    ü§ñ Ir a ChatGPT (Copia autom√°tica)
                </button>
            </div>
        </div>

        <!-- Pantalla para pegar respuesta de ChatGPT -->
        <div id="pantalla-input" class="card hidden">
            <h2 class="card-title">üì• Pega la respuesta de ChatGPT</h2>
            
            <div class="alert alert-info">
                <strong>üí° C√≥mo pegar la respuesta:</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li>Copia TODO el JSON que ChatGPT te devolvi√≥</li>
                    <li>Debe empezar con <code>&#123;</code> y terminar con <code>&#125;</code></li>
                    <li>No copies texto adicional, solo el JSON</li>
                </ul>
            </div>

            <div class="input-group">
                <textarea id="json-input" rows="15" placeholder='Pega aqu√≠ el JSON completo de ChatGPT:

{
  "titulo": "...",
  "texto": "...",
  "vocabulario": [...],
  ...
}'></textarea>
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-save-big" onclick="mostrarModalGuardarDesdeInput()">
                    üíæ ¬°Guardar esta lectura ahora!
                </button>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-primary" onclick="prepararImpresion()" style="padding: 20px 40px; font-size: 1.3em;">
                    üñ®Ô∏è Imprimir Lectura para Clase
                </button>
                <p style="color: #6b7280; margin-top: 10px; font-size: 0.95em;">
                    Genera un PDF bonito con la lectura y actividades para tus alumnos
                </p>
            </div>

            <div class="flex">
                <button class="btn btn-outline flex-1" onclick="volverPrompt()">‚Üê Volver</button>
                <button class="btn btn-primary flex-1" onclick="procesarJSON()">‚ú® Generar Lectura Interactiva</button>
            </div>
        </div>

        <!-- Actividades Previas -->
        <div id="pantalla-actividades" class="card hidden">
            <h2 class="card-title">üéØ Antes de leer: <span id="titulo-lectura"></span></h2>
            
            <div id="vocabulario-container"></div>
            <div id="contexto-container"></div>
            <div id="predicciones-container"></div>

            <button class="btn btn-primary" onclick="irALectura()" style="width: 100%; padding: 20px; font-size: 1.3em; margin-top: 30px;">
                ¬°Comenzar a leer! üìñ
            </button>
        </div>

        <!-- Lectura -->
        <div id="pantalla-lectura" class="card hidden">
            <h2 class="card-title" style="text-align: center; font-size: 2em;">
                üìñ <span id="titulo-lectura-2"></span>
            </h2>
            
            <div class="texto-lectura" id="texto-lectura"></div>

            <button class="btn btn-primary" onclick="irAPreguntas()" style="width: 100%; padding: 20px; font-size: 1.3em; margin-top: 30px;">
                Responder preguntas ‚Üí
            </button>
        </div>

        <!-- Preguntas -->
        <div id="pantalla-preguntas" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="card-title" id="pregunta-numero"></h2>
                <span class="badge badge-primary" id="tipo-pregunta"></span>
            </div>
            
            <div class="pregunta-card">
                <div class="pregunta-texto" id="pregunta-texto"></div>
                <div id="opciones-container"></div>
            </div>

            <button class="btn btn-primary" onclick="siguientePregunta()" id="btn-siguiente" style="width: 100%; padding: 20px; font-size: 1.3em; margin-top: 20px;" disabled>
                Siguiente pregunta ‚Üí
            </button>
        </div>

        <!-- Resultados -->
        <div id="pantalla-resultados" class="card hidden">
            <h2 class="card-title" style="text-align: center; font-size: 2em;">üéâ ¬°Actividad completada!</h2>
            
            <div class="puntuacion">
                <div style="font-size: 1.5em;">Puntuaci√≥n</div>
                <div class="puntuacion-numero"><span id="puntuacion-correctas">0</span> / <span id="puntuacion-total">0</span></div>
                <div style="font-size: 1.8em;"><span id="puntuacion-porcentaje">0</span>% de respuestas correctas</div>
            </div>

            <div id="resultados-detalle"></div>

            <div class="flex" style="margin-top: 30px;">
                <button class="btn btn-warning flex-1" onclick="mostrarModalGuardar()" style="padding: 20px; font-size: 1.2em;">
                    üíæ Guardar lectura
                </button>
                <button class="btn btn-success flex-1" onclick="irAActividadesPosteriores()" style="padding: 20px; font-size: 1.2em;">
                    Actividades despu√©s de leer ‚Üí
                </button>
            </div>

            <button class="btn btn-outline" onclick="volverInicio()" style="width: 100%; margin-top: 15px;">
                üîÑ Nueva lectura
            </button>
        </div>

        <!-- Actividades Posteriores -->
        <div id="pantalla-actividades-posteriores" class="card hidden">
            <h2 class="card-title" style="text-align: center; font-size: 2em;">üéØ Actividades despu√©s de la lectura</h2>
            
            <div class="alert alert-info">
                üí° <strong>Para el maestro:</strong> Estas son actividades orales para realizar en grupo despu√©s de la lectura.
            </div>

            <div id="actividades-posteriores-container"></div>

            <div class="flex" style="margin-top: 30px;">
                <button class="btn btn-outline flex-1" onclick="volverResultados()">‚Üê Ver resultados</button>
                <button class="btn btn-primary flex-1" onclick="volverInicio()">üîÑ Nueva lectura</button>
            </div>
        </div>

        <!-- Lecturas Guardadas -->
        <div id="pantalla-guardadas" class="card hidden">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                <h2 class="card-title" style="flex: 1;">üìö Lecturas Guardadas</h2>
                <button class="btn btn-outline" onclick="cerrarGuardadas()">‚Üê Volver</button>
            </div>
            
            <div id="lecturas-guardadas-container"></div>
        </div>

        <div class="footer">
            Made with <span class="heart">‚ù§Ô∏è</span> by V√≠ctor
        </div>
    </div>

    <!-- Modal para seleccionar preguntas a imprimir -->
    <div id="modal-seleccionar-preguntas" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2 style="color: #667eea; margin-bottom: 20px;">üñ®Ô∏è Selecciona las preguntas a imprimir</h2>
            
            <div class="alert alert-info">
                üí° <strong>Personaliza tu hoja de trabajo:</strong> Marca las preguntas que quieres incluir en la impresi√≥n.
            </div>

            <div style="margin: 20px 0;">
                <button class="btn btn-outline" onclick="seleccionarTodasPreguntas(true)" style="margin-right: 10px;">
                    ‚úÖ Seleccionar todas
                </button>
                <button class="btn btn-outline" onclick="seleccionarTodasPreguntas(false)">
                    ‚ùå Deseleccionar todas
                </button>
            </div>

            <div class="checkbox-list" id="lista-preguntas-imprimir"></div>

            <div class="flex" style="margin-top: 30px;">
                <button class="btn btn-outline flex-1" onclick="cerrarModalPreguntas()">Cancelar</button>
                <button class="btn btn-success flex-1" onclick="imprimirLectura()">üñ®Ô∏è Imprimir ahora</button>
            </div>
        </div>
    </div>

    <!-- P√°gina de impresi√≥n (oculta, solo visible al imprimir) -->
    <div id="pagina-impresion">
        <!-- El contenido se genera din√°micamente -->
    </div>

    <!-- Modal para guardar lectura -->
    <div id="modal-guardar" class="modal">
        <div class="modal-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üíæ Guardar lectura</h2>
            <div class="input-group">
                <label>Nombre de la lectura:</label>
                <input type="text" id="nombre-lectura" placeholder="Ej: Los dinosaurios - 3¬∫ Primaria">
            </div>
            <div class="flex" style="margin-top: 30px;">
                <button class="btn btn-outline flex-1" onclick="cerrarModalGuardar()">Cancelar</button>
                <button class="btn btn-primary flex-1" onclick="guardarLectura()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de instrucciones ChatGPT -->
    <div id="modal-instrucciones" class="modal">
        <div class="modal-content">
            <h2 style="color: #10b981; margin-bottom: 20px;">ü§ñ ¬°Prompt copiado!</h2>
            <div class="alert alert-info" style="margin: 20px 0;">
                <strong>Pasos a seguir:</strong>
                <ol style="margin: 15px 0 0 20px; line-height: 1.8;">
                    <li><strong>ChatGPT se abrir√° en una nueva pesta√±a</strong></li>
                    <li><strong>Pega el prompt</strong> (Ctrl+V o Cmd+V)</li>
                    <li><strong>Env√≠a el mensaje</strong> a ChatGPT</li>
                    <li><strong>Copia TODO el JSON</strong> que te devuelva</li>
                    <li><strong>Vuelve aqu√≠</strong> y p√©galo en el siguiente paso</li>
                </ol>
            </div>
            <button class="btn btn-success" onclick="cerrarModalInstrucciones()" style="width: 100%; padding: 15px; font-size: 1.2em;">
                ¬°Entendido! Vamos all√° üöÄ
            </button>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        const app = {
            modo: null,
            curso: null,
            trimestre: null,
            tema: '',
            valor: '',
            vocabulario: '',
            prompt: '',
            lecturaData: null,
            currentQuestion: 0,
            respuestas: {}
        };

        const cursosInfo = {
            '1': { nombre: '1.¬∫ de Primaria', emoji: 'üìò' },
            '2': { nombre: '2.¬∫ de Primaria', emoji: 'üìó' },
            '3': { nombre: '3.¬∫ de Primaria', emoji: 'üìô' },
            '4': { nombre: '4.¬∫ de Primaria', emoji: 'üìí' },
            '5': { nombre: '5.¬∫ de Primaria', emoji: 'üìï' },
            '6': { nombre: '6.¬∫ de Primaria', emoji: 'üìî' }
        };

        const planLecturaInfo = {
            '1': {
                '1': { tipos: 'cuentos breves, textos rimados, adivinanzas, carteles del aula', longitud: '60-100', preguntas: '4-6 (4 literales, 1 inferencial, 1 valorativa)' },
                '2': { tipos: 'textos narrativos breves con estructura sencilla (inicio-nudo-desenlace), recetas simples', longitud: '60-100', preguntas: '4-6 (4 literales, 1 inferencial, 1 valorativa)' },
                '3': { tipos: 'descripciones de personas, animales o lugares, c√≥mics sencillos', longitud: '60-100', preguntas: '4-6 (4 literales, 1 inferencial, 1 valorativa)' }
            },
            '2': {
                '1': { tipos: 'cuentos tradicionales y f√°bulas cortas', longitud: '100-150', preguntas: '6-8 (4 literales, 2 inferenciales, 1 valorativa)' },
                '2': { tipos: 'textos instructivos (recetas, normas de juego)', longitud: '100-150', preguntas: '6-8 (4 literales, 2 inferenciales, 1 valorativa)' },
                '3': { tipos: 'textos informativos sencillos (animales, oficios)', longitud: '100-150', preguntas: '6-8 (4 literales, 2 inferenciales, 1 valorativa)' }
            },
            '3': {
                '1': { tipos: 'narrativos con m√°s de un personaje y secuencias temporales', longitud: '150-200', preguntas: '8-10 (4 literales, 3 inferenciales, 2 cr√≠ticas)' },
                '2': { tipos: 'textos expositivos cortos sobre temas naturales o sociales', longitud: '150-200', preguntas: '8-10 (4 literales, 3 inferenciales, 2 cr√≠ticas)' },
                '3': { tipos: 'poemas, leyendas o fragmentos de novelas infantiles', longitud: '150-200', preguntas: '8-10 (4 literales, 3 inferenciales, 2 cr√≠ticas)' }
            },
            '4': {
                '1': { tipos: 'narraciones con estructura compleja (dos escenarios o tiempos)', longitud: '200-250', preguntas: '10-12 (4 literales, 4 inferenciales, 2-3 cr√≠ticas)' },
                '2': { tipos: 'textos expositivos (informes breves, divulgativos)', longitud: '200-250', preguntas: '10-12 (4 literales, 4 inferenciales, 2-3 cr√≠ticas)' },
                '3': { tipos: 'textos dialogados (teatro corto, entrevistas)', longitud: '200-250', preguntas: '10-12 (4 literales, 4 inferenciales, 2-3 cr√≠ticas)' }
            },
            '5': {
                '1': { tipos: 'relatos hist√≥ricos o de aventuras', longitud: '250-300', preguntas: '12-14 (4 literales, 5 inferenciales, 3-4 cr√≠ticas)' },
                '2': { tipos: 'textos expositivos y argumentativos breves', longitud: '250-300', preguntas: '12-14 (4 literales, 5 inferenciales, 3-4 cr√≠ticas)' },
                '3': { tipos: 'textos period√≠sticos o de divulgaci√≥n', longitud: '250-300', preguntas: '12-14 (4 literales, 5 inferenciales, 3-4 cr√≠ticas)' }
            },
            '6': {
                '1': { tipos: 'textos narrativos extensos o fragmentos de novelas juveniles', longitud: '300-400', preguntas: '14-15 (4 literales, 6 inferenciales, 4-6 cr√≠ticas)' },
                '2': { tipos: 'textos argumentativos (opini√≥n, debate escolar)', longitud: '300-400', preguntas: '14-15 (4 literales, 6 inferenciales, 4-6 cr√≠ticas)' },
                '3': { tipos: 'textos expositivos de divulgaci√≥n y art√≠culos breves', longitud: '300-400', preguntas: '14-15 (4 literales, 6 inferenciales, 4-6 cr√≠ticas)' }
            }
        };

        const actividadesPosteriores = {
            '1': [
                'üß© Reconstruyo la historia: los alumnos ordenan oralmente las partes del cuento (inicio, nudo, desenlace).',
                'üé≠ Dramatizaci√≥n: representar brevemente un fragmento con gestos o peque√±os di√°logos.',
                'üëÇ ¬øQui√©n dijo qu√©?: identificar oralmente qu√© personaje pronunci√≥ una frase.',
                'üí¨ Mi parte favorita: cada alumno explica qu√© parte le gust√≥ m√°s y por qu√©.',
                'üß† Preguntas del texto: responder oralmente a preguntas sencillas sobre personajes, lugares o acciones.'
            ],
            '2': [
                'üó£Ô∏è Cuento el cuento con mis palabras: reconstrucci√≥n oral del texto.',
                'ü™Ñ Entrevista al personaje: un alumno hace de personaje y los dem√°s le preguntan.',
                'üéØ Verdadero o falso oral: responder y justificar brevemente.',
                'üí° Cambiamos el final: proponer un desenlace diferente.',
                'üé® Palabras nuevas: comentar en grupo el significado de vocablos nuevos o curiosos.'
            ],
            '3': [
                'üîÅ Resumen oral en grupo: reconstrucci√≥n colaborativa del contenido.',
                'üé≠ Rueda de personajes: cada alumno asume un personaje y responde como √©l.',
                'üïµÔ∏è Detectives de pistas: explicar qu√© detalles del texto ayudaron a entender algo no dicho.',
                'üéôÔ∏è Noticias del cuento: narrar el texto como si fuera una noticia.',
                'üí¨ Opini√≥n personal: expresar si les gust√≥ el texto y qu√© mensaje transmite.'
            ],
            '4': [
                'üé§ Rueda de preguntas: el alumnado formula preguntas entre s√≠ sobre la lectura.',
                'üé≠ Entrevista colectiva: el grupo entrevista a un personaje o al autor imaginario.',
                'üí¨ Debate guiado: opinar sobre las decisiones o comportamientos de los personajes.',
                'üß† Interpretaci√≥n del t√≠tulo: explicar por qu√© se llama as√≠ el texto o proponer otro t√≠tulo.',
                'üìö Recomendaci√≥n lectora: contar por qu√© recomendar√≠an esa lectura a otros compa√±eros.'
            ],
            '5': [
                'üéôÔ∏è Club de lectura oral: comentar los aspectos que m√°s les hicieron pensar.',
                'üó£Ô∏è Comparo textos: hablar sobre semejanzas o diferencias con otras lecturas.',
                '‚öñÔ∏è Tribunal de personajes: decidir colectivamente si un personaje actu√≥ bien o mal y argumentarlo.',
                'üéØ Resumen en tres ideas: sintetizar oralmente el texto en tres frases.',
                'üß≠ Conexi√≥n personal: relacionar el contenido con una experiencia propia.'
            ],
            '6': [
                'üé§ Foro de opini√≥n: expresar y debatir distintos puntos de vista sobre el tema del texto.',
                'üß† Interpretaciones alternativas: discutir diferentes significados o lecturas posibles.',
                'üì∞ Rueda de prensa: un grupo act√∫a como periodistas y otro como personajes del texto.',
                'üó≥Ô∏è Voto argumentado: elegir y justificar oralmente el mejor personaje o el acto m√°s justo.',
                'üìö Rese√±a oral: explicar de forma breve el argumento y ofrecer una valoraci√≥n personal.'
            ]
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            actualizarContadorGuardadas();
        });

        function actualizarContadorGuardadas() {
            const guardadas = JSON.parse(localStorage.getItem('lecturasGuardadas') || '[]');
            document.getElementById('contador-guardadas').textContent = guardadas.length;
        }

        function seleccionarModo(modo) {
            app.modo = modo;
            mostrarPantalla('pantalla-configuracion');
            
            const titulo = modo === 'libre' ? 'üìù Tipo Libre' : 'üìö Plan de Lectura';
            document.getElementById('modo-titulo').textContent = titulo;
            
            // Generar botones de cursos
            const cursosContainer = document.getElementById('cursos-container');
            cursosContainer.innerHTML = '';
            Object.entries(cursosInfo).forEach(([key, info]) => {
                const btn = document.createElement('button');
                btn.className = 'curso-btn';
                btn.innerHTML = `<div style="font-size: 2em;">${info.emoji}</div><div>${info.nombre}</div>`;
                btn.onclick = () => seleccionarCurso(key);
                cursosContainer.appendChild(btn);
            });
            
            if (modo === 'plan') {
                document.getElementById('trimestre-container').classList.remove('hidden');
            } else {
                document.getElementById('trimestre-container').classList.add('hidden');
            }
        }

        function seleccionarCurso(curso) {
            app.curso = curso;
            // Actualizar selecci√≥n visual
            document.querySelectorAll('#cursos-container .curso-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.curso-btn').classList.add('selected');
            
            document.getElementById('opciones-adicionales').classList.remove('hidden');
        }

        function seleccionarTrimestre(trimestre) {
            app.trimestre = trimestre;
            document.querySelectorAll('#trimestre-container .curso-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function generarPrompt() {
            if (!app.curso || (app.modo === 'plan' && !app.trimestre)) {
                alert('Por favor, selecciona todos los campos obligatorios');
                return;
            }

            app.tema = document.getElementById('tema').value;
            app.valor = document.getElementById('valor').value;
            app.vocabulario = document.getElementById('vocabulario').value;

            let promptText = '';
            
            if (app.modo === 'libre') {
                const info = cursosInfo[app.curso];
                promptText = `Genera una lectura de comprensi√≥n para ${info.nombre} de Educaci√≥n Primaria en Andaluc√≠a.
${app.tema ? `\nTEMA ESPEC√çFICO: ${app.tema}` : ''}
${app.valor ? `\nVALOR A TRABAJAR: ${app.valor}` : ''}
${app.vocabulario ? `\nVOCABULARIO A INCLUIR: ${app.vocabulario}` : ''}

IMPORTANTE: Devuelve √öNICAMENTE un objeto JSON v√°lido con esta estructura exacta (sin texto adicional antes o despu√©s):

{
  "titulo": "T√≠tulo de la lectura",
  "texto": "Texto completo de la lectura apropiado para el nivel",
  "vocabulario": ["palabra1: definici√≥n", "palabra2: definici√≥n", "palabra3: definici√≥n"],
  "predicciones": ["Pregunta de predicci√≥n 1", "Pregunta de predicci√≥n 2"],
  "preguntas": [
    {
      "pregunta": "Texto de la pregunta",
      "tipo": "literal",
      "opciones": ["opci√≥n A", "opci√≥n B", "opci√≥n C", "opci√≥n D"],
      "correcta": 0
    }
  ]
}

Especificaciones:
- Longitud del texto: apropiada para ${info.nombre}
- Incluir preguntas de comprensi√≥n (literales, inferenciales y cr√≠ticas/valorativas)
- Cada pregunta debe tener 4 opciones de respuesta
- El campo "correcta" indica el √≠ndice de la opci√≥n correcta (0, 1, 2 o 3)
- Incluir 2-3 palabras de vocabulario previo con sus definiciones
- Incluir 2 preguntas de predicci√≥n sobre el texto${app.vocabulario ? `\n- IMPORTANTE: Incluir estas palabras de vocabulario en el texto y explicarlas: ${app.vocabulario}` : ''}${app.valor ? `\n- IMPORTANTE: El texto debe reflejar y trabajar el valor: ${app.valor}` : ''}`;
            } else {
                const info = cursosInfo[app.curso];
                const planInfo = planLecturaInfo[app.curso][app.trimestre];
                promptText = `Genera una lectura de comprensi√≥n siguiendo el Plan de Lectura de Andaluc√≠a.

CURSO: ${info.nombre}
TRIMESTRE: ${app.trimestre}.¬∫ trimestre
${app.tema ? `\nTEMA ESPEC√çFICO: ${app.tema}` : ''}
${app.valor ? `\nVALOR A TRABAJAR: ${app.valor}` : ''}
${app.vocabulario ? `\nVOCABULARIO A INCLUIR: ${app.vocabulario}` : ''}

ESPECIFICACIONES DEL PLAN DE LECTURA:
- Tipos de textos: ${planInfo.tipos}
- Longitud: ${planInfo.longitud} palabras
- Preguntas: ${planInfo.preguntas}

IMPORTANTE: Devuelve √öNICAMENTE un objeto JSON v√°lido con esta estructura exacta (sin texto adicional antes o despu√©s):

{
  "titulo": "T√≠tulo de la lectura",
  "texto": "Texto completo de la lectura",
  "vocabulario": ["palabra1: definici√≥n", "palabra2: definici√≥n", "palabra3: definici√≥n"],
  "predicciones": ["Pregunta de predicci√≥n 1", "Pregunta de predicci√≥n 2"],
  "contexto": "Texto de contextualizaci√≥n o pregunta motivadora (seg√∫n el curso)",
  "preguntas": [
    {
      "pregunta": "Texto de la pregunta",
      "tipo": "literal",
      "opciones": ["opci√≥n A", "opci√≥n B", "opci√≥n C", "opci√≥n D"],
      "correcta": 0
    }
  ]
}

IMPORTANTE:
- Cada pregunta debe tener exactamente 4 opciones
- El campo "correcta" indica el √≠ndice (0-3) de la opci√≥n correcta
- Distribuir las preguntas seg√∫n el tipo especificado (literales, inferenciales, cr√≠ticas)
- El texto debe tener la longitud especificada${app.vocabulario ? `\n- IMPORTANTE: Incluir estas palabras de vocabulario en el texto y explicarlas: ${app.vocabulario}` : ''}${app.valor ? `\n- IMPORTANTE: El texto debe reflejar y trabajar el valor: ${app.valor}` : ''}`;
            }

            app.prompt = promptText;
            document.getElementById('prompt-display').textContent = promptText;
            mostrarPantalla('pantalla-prompt');
        }

        function irAChatGPT() {
            // Copiar autom√°ticamente el prompt
            navigator.clipboard.writeText(app.prompt).then(() => {
                // Mostrar indicador de copiado
                const indicator = document.createElement('div');
                indicator.className = 'copy-indicator';
                indicator.innerHTML = '‚úÖ ¬°Prompt copiado!';
                document.body.appendChild(indicator);
                
                setTimeout(() => {
                    indicator.remove();
                }, 2000);

                // Mostrar modal de instrucciones
                document.getElementById('modal-instrucciones').classList.add('active');
                
                // Abrir ChatGPT
                window.open('https://chat.openai.com', '_blank');
                
                // Ir a la siguiente pantalla
                setTimeout(() => {
                    mostrarPantalla('pantalla-input');
                }, 1000);
            });
        }

        function cerrarModalInstrucciones() {
            document.getElementById('modal-instrucciones').classList.remove('active');
        }

        function volverPrompt() {
            mostrarPantalla('pantalla-prompt');
        }

        function procesarJSON() {
            const jsonInput = document.getElementById('json-input').value;
            
            if (!jsonInput.trim()) {
                alert('Por favor, pega el JSON de ChatGPT');
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                
                // Validar que tiene los campos m√≠nimos necesarios
                if (!data.titulo || !data.texto || !data.preguntas) {
                    alert('El JSON no tiene todos los campos necesarios (titulo, texto, preguntas)');
                    return;
                }
                
                // A√±adir actividades posteriores aleatorias
                const actividades = actividadesPosteriores[app.curso];
                const mezcladas = [...actividades].sort(() => Math.random() - 0.5);
                data.actividadesPosteriores = mezcladas.slice(0, 2);
                
                app.lecturaData = data;
                app.respuestas = {};
                app.currentQuestion = 0;
                
                console.log('Lectura cargada:', app.lecturaData);
                mostrarActividadesPrevias();
            } catch (e) {
                console.error('Error al parsear JSON:', e);
                alert('Error al procesar el JSON. Aseg√∫rate de copiar correctamente la respuesta de ChatGPT.\n\nError: ' + e.message);
            }
        }

        function mostrarActividadesPrevias() {
            mostrarPantalla('pantalla-actividades');
            
            document.getElementById('titulo-lectura').textContent = app.lecturaData.titulo;
            
            // Limpiar contenedores primero
            document.getElementById('vocabulario-container').innerHTML = '';
            document.getElementById('contexto-container').innerHTML = '';
            document.getElementById('predicciones-container').innerHTML = '';
            
            // Vocabulario
            if (app.lecturaData.vocabulario && app.lecturaData.vocabulario.length > 0) {
                const vocabHtml = `
                    <div style="margin: 30px 0;">
                        <h3 style="color: #667eea; font-size: 1.5em; margin-bottom: 15px;">üìö Vocabulario importante</h3>
                        ${app.lecturaData.vocabulario.map(v => `
                            <div class="actividad-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                                ${v}
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('vocabulario-container').innerHTML = vocabHtml;
            }
            
            // Contexto
            if (app.lecturaData.contexto) {
                const contextoHtml = `
                    <div style="margin: 30px 0;">
                        <h3 style="color: #667eea; font-size: 1.5em; margin-bottom: 15px;">üí≠ Pensemos antes de leer</h3>
                        <div class="actividad-box" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
                            ${app.lecturaData.contexto}
                        </div>
                    </div>
                `;
                document.getElementById('contexto-container').innerHTML = contextoHtml;
            }
            
            // Predicciones
            if (app.lecturaData.predicciones && app.lecturaData.predicciones.length > 0) {
                const prediccionesHtml = `
                    <div style="margin: 30px 0;">
                        <h3 style="color: #667eea; font-size: 1.5em; margin-bottom: 15px;">üîÆ ¬øQu√© crees que pasar√°?</h3>
                        ${app.lecturaData.predicciones.map(p => `
                            <div class="actividad-box" style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);">
                                ${p}
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('predicciones-container').innerHTML = prediccionesHtml;
            }
        }

        function irALectura() {
            mostrarPantalla('pantalla-lectura');
            document.getElementById('titulo-lectura-2').textContent = app.lecturaData.titulo;
            document.getElementById('texto-lectura').textContent = app.lecturaData.texto;
        }

        function irAPreguntas() {
            mostrarPantalla('pantalla-preguntas');
            mostrarPreguntaActual();
        }

        function mostrarPreguntaActual() {
            const pregunta = app.lecturaData.preguntas[app.currentQuestion];
            const tipoEmojis = {
                'literal': 'üìù',
                'inferencial': 'ü§î',
                'critica': 'üí≠',
                'valorativa': '‚≠ê'
            };
            
            document.getElementById('pregunta-numero').textContent = 
                `${tipoEmojis[pregunta.tipo] || '‚ùì'} Pregunta ${app.currentQuestion + 1} de ${app.lecturaData.preguntas.length}`;
            document.getElementById('tipo-pregunta').textContent = pregunta.tipo;
            document.getElementById('pregunta-texto').textContent = pregunta.pregunta;
            
            const opcionesHtml = pregunta.opciones.map((opcion, idx) => `
                <div class="opcion" onclick="seleccionarOpcion(${idx})">
                    <strong>${String.fromCharCode(65 + idx)}.</strong> ${opcion}
                </div>
            `).join('');
            
            document.getElementById('opciones-container').innerHTML = opcionesHtml;
            
            const btnSiguiente = document.getElementById('btn-siguiente');
            btnSiguiente.disabled = true;
            
            // Actualizar texto del bot√≥n seg√∫n si es la √∫ltima pregunta
            if (app.currentQuestion < app.lecturaData.preguntas.length - 1) {
                btnSiguiente.textContent = 'Siguiente pregunta ‚Üí';
            } else {
                btnSiguiente.textContent = 'Ver resultados üéØ';
            }
        }

        function seleccionarOpcion(idx) {
            app.respuestas[app.currentQuestion] = idx;
            
            document.querySelectorAll('.opcion').forEach((el, i) => {
                el.classList.toggle('selected', i === idx);
            });
            
            document.getElementById('btn-siguiente').disabled = false;
        }

        function siguientePregunta() {
            if (app.currentQuestion < app.lecturaData.preguntas.length - 1) {
                app.currentQuestion++;
                mostrarPreguntaActual();
            } else {
                mostrarResultados();
            }
        }

        function mostrarResultados() {
            mostrarPantalla('pantalla-resultados');
            
            let correctas = 0;
            app.lecturaData.preguntas.forEach((pregunta, idx) => {
                if (app.respuestas[idx] === pregunta.correcta) {
                    correctas++;
                }
            });
            
            const total = app.lecturaData.preguntas.length;
            const porcentaje = Math.round((correctas / total) * 100);
            
            document.getElementById('puntuacion-correctas').textContent = correctas;
            document.getElementById('puntuacion-total').textContent = total;
            document.getElementById('puntuacion-porcentaje').textContent = porcentaje;
            
            const detalleHtml = app.lecturaData.preguntas.map((pregunta, idx) => {
                const esCorrecta = app.respuestas[idx] === pregunta.correcta;
                return `
                    <div class="opcion ${esCorrecta ? 'resultado-correcto' : 'resultado-incorrecto'}" style="margin: 15px 0; padding: 20px;">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            <div style="font-size: 2em;">${esCorrecta ? '‚úÖ' : '‚ùå'}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 10px;">${pregunta.pregunta}</div>
                                <div><strong>Tu respuesta:</strong> ${pregunta.opciones[app.respuestas[idx]]}</div>
                                ${!esCorrecta ? `<div style="color: #059669; margin-top: 5px;"><strong>Correcta:</strong> ${pregunta.opciones[pregunta.correcta]}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('resultados-detalle').innerHTML = detalleHtml;
        }

        function irAActividadesPosteriores() {
            mostrarPantalla('pantalla-actividades-posteriores');
            
            const actividadesHtml = app.lecturaData.actividadesPosteriores.map(actividad => `
                <div class="actividad-box">
                    ${actividad}
                </div>
            `).join('');
            
            document.getElementById('actividades-posteriores-container').innerHTML = actividadesHtml;
        }

        function volverResultados() {
            mostrarPantalla('pantalla-resultados');
        }

        function mostrarModalGuardar() {
            document.getElementById('modal-guardar').classList.add('active');
            document.getElementById('nombre-lectura').value = '';
            document.getElementById('nombre-lectura').focus();
        }

        function mostrarModalGuardarDesdeInput() {
            const jsonInput = document.getElementById('json-input').value;
            
            if (!jsonInput.trim()) {
                alert('Por favor, pega primero el JSON de ChatGPT antes de guardar');
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                
                // Validar campos b√°sicos
                if (!data.titulo || !data.texto || !data.preguntas) {
                    alert('El JSON no tiene todos los campos necesarios');
                    return;
                }
                
                // A√±adir actividades posteriores
                const actividades = actividadesPosteriores[app.curso];
                const mezcladas = [...actividades].sort(() => Math.random() - 0.5);
                data.actividadesPosteriores = mezcladas.slice(0, 2);
                
                app.lecturaData = data;
                app.respuestas = {};
                
                // Ahora mostramos el modal de guardar
                mostrarModalGuardar();
            } catch (e) {
                console.error('Error:', e);
                alert('Error al procesar el JSON. Verifica que est√© correcto.\n\nError: ' + e.message);
            }
        }

        function cerrarModalGuardar() {
            document.getElementById('modal-guardar').classList.remove('active');
        }

        function guardarLectura() {
            const nombre = document.getElementById('nombre-lectura').value.trim();
            
            if (!nombre) {
                alert('Por favor, escribe un nombre para la lectura');
                return;
            }

            if (!app.lecturaData) {
                alert('No hay datos de lectura para guardar');
                return;
            }

            const lecturas = JSON.parse(localStorage.getItem('lecturasGuardadas') || '[]');
            const nuevaLectura = {
                id: Date.now(),
                nombre: nombre,
                curso: app.curso,
                modo: app.modo,
                trimestre: app.trimestre,
                tema: app.tema,
                valor: app.valor,
                fecha: new Date().toLocaleDateString('es-ES'),
                data: app.lecturaData,
                respuestas: app.respuestas
            };

            lecturas.push(nuevaLectura);
            localStorage.setItem('lecturasGuardadas', JSON.stringify(lecturas));
            
            cerrarModalGuardar();
            actualizarContadorGuardadas();
            
            const indicator = document.createElement('div');
            indicator.className = 'copy-indicator';
            indicator.innerHTML = '‚úÖ ¬°Lectura guardada correctamente!';
            indicator.style.background = '#10b981';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 3000);
            
            console.log('Lectura guardada:', nuevaLectura);
        }

        function mostrarGuardadas() {
            const lecturas = JSON.parse(localStorage.getItem('lecturasGuardadas') || '[]');
            mostrarPantalla('pantalla-guardadas');
            
            if (lecturas.length === 0) {
                document.getElementById('lecturas-guardadas-container').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üìö</div>
                        <p style="font-size: 1.3em; color: #6b7280; margin-bottom: 30px;">No hay lecturas guardadas todav√≠a</p>
                        <button class="btn btn-primary" onclick="cerrarGuardadas()">Crear primera lectura</button>
                    </div>
                `;
            } else {
                const lecturasHtml = lecturas.map((lectura, idx) => `
                    <div class="lectura-guardada">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h3 style="font-size: 1.3em; margin-bottom: 10px;">
                                    ${cursosInfo[lectura.curso].emoji} ${lectura.nombre}
                                </h3>
                                <p style="color: #6b7280; margin: 5px 0;">
                                    <strong>Curso:</strong> ${cursosInfo[lectura.curso].nombre}
                                    ${lectura.trimestre ? ` - ${lectura.trimestre}.¬∫ Trimestre` : ''}
                                </p>
                                ${lectura.tema ? `<p style="color: #6b7280; margin: 5px 0;"><strong>Tema:</strong> ${lectura.tema}</p>` : ''}
                                ${lectura.valor ? `<p style="color: #6b7280; margin: 5px 0;"><strong>Valor:</strong> ${lectura.valor}</p>` : ''}
                                <p style="color: #9ca3af; font-size: 0.9em; margin-top: 10px;">Guardada el ${lectura.fecha}</p>
                            </div>
                            <div style="display: flex; gap: 10px; margin-left: 20px;">
                                <button class="btn btn-success" onclick="cargarLecturaById(${lectura.id})">Abrir</button>
                                <button class="btn btn-danger" onclick="eliminarLectura(${lectura.id})">Eliminar</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('lecturas-guardadas-container').innerHTML = lecturasHtml;
            }
        }

        function cargarLectura(lectura) {
            app.modo = lectura.modo;
            app.curso = lectura.curso;
            app.trimestre = lectura.trimestre;
            app.tema = lectura.tema;
            app.valor = lectura.valor;
            app.lecturaData = lectura.data;
            app.respuestas = {};
            app.currentQuestion = 0;
            
            mostrarActividadesPrevias();
        }

        function cargarLecturaById(id) {
            const lecturas = JSON.parse(localStorage.getItem('lecturasGuardadas') || '[]');
            const lectura = lecturas.find(l => l.id === id);
            
            if (lectura) {
                cargarLectura(lectura);
            }
        }

        function eliminarLectura(id) {
            if (!confirm('¬øSeguro que quieres eliminar esta lectura?')) return;
            
            const lecturas = JSON.parse(localStorage.getItem('lecturasGuardadas') || '[]');
            const nuevasLecturas = lecturas.filter(l => l.id !== id);
            localStorage.setItem('lecturasGuardadas', JSON.stringify(nuevasLecturas));
            
            actualizarContadorGuardadas();
            mostrarGuardadas();
        }

        function cerrarGuardadas() {
            mostrarPantalla('pantalla-config');
        }

        function volverInicio() {
            app.modo = null;
            app.curso = null;
            app.trimestre = null;
            app.tema = '';
            app.valor = '';
            app.vocabulario = '';
            app.lecturaData = null;
            app.respuestas = {};
            app.currentQuestion = 0;
            
            document.getElementById('tema').value = '';
            document.getElementById('valor').value = '';
            document.getElementById('vocabulario').value = '';
            document.getElementById('json-input').value = '';
            
            mostrarPantalla('pantalla-config');
        }

        function mostrarPantalla(id) {
            document.querySelectorAll('.card').forEach(el => {
                el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        // ===== FUNCIONES DE IMPRESI√ìN =====

        let preguntasSeleccionadas = [];

        function prepararImpresion() {
            const jsonInput = document.getElementById('json-input').value;
            
            if (!jsonInput.trim()) {
                alert('Por favor, pega primero el JSON de ChatGPT');
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                
                if (!data.titulo || !data.texto || !data.preguntas) {
                    alert('El JSON no tiene todos los campos necesarios');
                    return;
                }
                
                // A√±adir actividades posteriores si no las tiene
                if (!data.actividadesPosteriores) {
                    const actividades = actividadesPosteriores[app.curso];
                    const mezcladas = [...actividades].sort(() => Math.random() - 0.5);
                    data.actividadesPosteriores = mezcladas.slice(0, 2);
                }
                
                app.lecturaData = data;
                
                mostrarModalSeleccionPreguntas();
            } catch (e) {
                alert('Error al procesar el JSON. Verifica que est√© correcto.\n\nError: ' + e.message);
            }
        }

        function mostrarModalSeleccionPreguntas() {
            document.getElementById('modal-seleccionar-preguntas').classList.add('active');
            
            const listaHtml = app.lecturaData.preguntas.map((pregunta, idx) => {
                const tipoEmojis = {
                    'literal': 'üìù',
                    'inferencial': 'ü§î',
                    'critica': 'üí≠',
                    'valorativa': '‚≠ê'
                };
                
                return `
                    <div class="checkbox-item" onclick="togglePregunta(${idx})">
                        <input type="checkbox" id="pregunta-${idx}" checked onchange="event.stopPropagation()">
                        <label for="pregunta-${idx}">
                            <strong>${tipoEmojis[pregunta.tipo] || '‚ùì'} Pregunta ${idx + 1}</strong>
                            <div style="margin-top: 5px; color: #6b7280;">${pregunta.pregunta}</div>
                            <div style="margin-top: 3px; font-size: 0.9em;">
                                <span class="badge badge-primary">${pregunta.tipo}</span>
                            </div>
                        </label>
                    </div>
                `;
            }).join('');
            
            document.getElementById('lista-preguntas-imprimir').innerHTML = listaHtml;
            
            // Seleccionar todas por defecto
            preguntasSeleccionadas = app.lecturaData.preguntas.map((_, idx) => idx);
        }

        function togglePregunta(idx) {
            const checkbox = document.getElementById(`pregunta-${idx}`);
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                if (!preguntasSeleccionadas.includes(idx)) {
                    preguntasSeleccionadas.push(idx);
                }
            } else {
                preguntasSeleccionadas = preguntasSeleccionadas.filter(i => i !== idx);
            }
        }

        function seleccionarTodasPreguntas(seleccionar) {
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach((checkbox, idx) => {
                checkbox.checked = seleccionar;
            });
            
            if (seleccionar) {
                preguntasSeleccionadas = app.lecturaData.preguntas.map((_, idx) => idx);
            } else {
                preguntasSeleccionadas = [];
            }
        }

        function cerrarModalPreguntas() {
            document.getElementById('modal-seleccionar-preguntas').classList.remove('active');
        }

        function imprimirLectura() {
            if (preguntasSeleccionadas.length === 0) {
                alert('Por favor, selecciona al menos una pregunta para imprimir');
                return;
            }
            
            generarPaginaImpresion();
            cerrarModalPreguntas();
            
            // Peque√±o delay para que se renderice antes de imprimir
            setTimeout(() => {
                window.print();
            }, 100);
        }

        function generarPaginaImpresion() {
            const data = app.lecturaData;
            const cursosNombre = cursosInfo[app.curso].nombre;
            
            let html = `
                <div class="print-header">
                    <h1>üìö ${data.titulo}</h1>
                    <div class="school">CEIP Capitulaciones Santa Fe</div>
                    <div style="color: #9ca3af; margin-top: 10px;">${cursosNombre}</div>
                    <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                        ${new Date().toLocaleDateString('es-ES', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}
                    </div>
                </div>
            `;
            
            // ANTES DE LEER
            html += `<div class="print-section">
                <div class="print-section-title">üéØ Antes de leer</div>`;
            
            // Vocabulario
            if (data.vocabulario && data.vocabulario.length > 0) {
                html += `<div style="margin: 20px 0;">
                    <h3 style="color: #667eea; font-size: 1.3em; margin-bottom: 15px;">üìö Vocabulario importante</h3>`;
                data.vocabulario.forEach(v => {
                    html += `<div class="print-vocab-item">${v}</div>`;
                });
                html += `</div>`;
            }
            
            // Contexto/Predicciones
            if (data.contexto) {
                html += `<div style="margin: 20px 0;">
                    <h3 style="color: #667eea; font-size: 1.3em; margin-bottom: 15px;">üí≠ Pensemos antes de leer</h3>
                    <div class="print-content">${data.contexto}</div>
                </div>`;
            }
            
            if (data.predicciones && data.predicciones.length > 0) {
                html += `<div style="margin: 20px 0;">
                    <h3 style="color: #667eea; font-size: 1.3em; margin-bottom: 15px;">üîÆ ¬øQu√© crees que pasar√°?</h3>`;
                data.predicciones.forEach(p => {
                    html += `<div class="print-content">${p}</div>`;
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            
            // DURANTE LA LECTURA
            html += `<div class="print-section" style="page-break-before: always;">
                <div class="print-section-title">üìñ Lectura</div>
                <div class="print-titulo-lectura">${data.titulo}</div>
                <div class="print-texto-lectura">${data.texto}</div>
            </div>`;
            
            // PREGUNTAS DE COMPRENSI√ìN
            if (preguntasSeleccionadas.length > 0) {
                html += `<div class="print-section" style="page-break-before: always;">
                    <div class="print-section-title">‚ùì Preguntas de comprensi√≥n</div>`;
                
                preguntasSeleccionadas.forEach((idx, numero) => {
                    const pregunta = data.preguntas[idx];
                    const tipoEmojis = {
                        'literal': 'üìù',
                        'inferencial': 'ü§î',
                        'critica': 'üí≠',
                        'valorativa': '‚≠ê'
                    };
                    
                    html += `<div class="print-pregunta">
                        <div class="print-pregunta-numero">
                            ${tipoEmojis[pregunta.tipo] || '‚ùì'} Pregunta ${numero + 1}
                            <span style="float: right; font-size: 0.8em; color: #6b7280;">(${pregunta.tipo})</span>
                        </div>
                        <div class="print-pregunta-texto">${pregunta.pregunta}</div>
                        <div class="print-respuesta-espacio"></div>
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            // DESPU√âS DE LEER
            if (data.actividadesPosteriores && data.actividadesPosteriores.length > 0) {
                html += `<div class="print-section" style="page-break-before: always;">
                    <div class="print-section-title">üéØ Despu√©s de leer (Actividades orales)</div>
                    <div class="alert alert-info" style="margin: 20px 0; padding: 15px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px;">
                        üí° <strong>Para el maestro:</strong> Estas actividades se realizan en grupo de forma oral.
                    </div>`;
                
                data.actividadesPosteriores.forEach((actividad, idx) => {
                    html += `<div class="print-content" style="margin: 15px 0;">
                        <strong>Actividad ${idx + 1}:</strong><br>
                        ${actividad}
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            // Footer en impresi√≥n
            html += `<div style="text-align: center; margin-top: 50px; padding-top: 20px; border-top: 2px solid #e5e7eb; color: #9ca3af;">
                Made with ‚ù§Ô∏è by V√≠ctor
            </div>`;
            
            document.getElementById('pagina-impresion').innerHTML = html;
        }
    </script>
</body>
</html>
